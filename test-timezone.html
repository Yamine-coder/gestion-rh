<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Test Timezone - Paris</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #1a1a2e; color: #eee; }
    .box { background: #16213e; padding: 20px; border-radius: 10px; margin: 15px 0; }
    .success { border-left: 4px solid #4ade80; }
    .error { border-left: 4px solid #f87171; }
    .warning { border-left: 4px solid #fbbf24; }
    h1 { color: #cf292c; }
    h2 { color: #60a5fa; margin-top: 0; }
    code { background: #0f0f23; padding: 2px 6px; border-radius: 4px; color: #fbbf24; }
    .result { font-size: 18px; font-weight: bold; }
    .old { color: #f87171; text-decoration: line-through; }
    .new { color: #4ade80; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    td, th { padding: 8px; text-align: left; border-bottom: 1px solid #333; }
    th { color: #60a5fa; }
  </style>
</head>
<body>
  <h1>ğŸ• Test Timezone - VÃ©rification Paris</h1>
  <p>Date/Heure systÃ¨me: <strong id="systemTime"></strong></p>
  
  <div class="box" id="currentTimeBox">
    <h2>ğŸ“… Date/Heure Actuelle</h2>
    <table>
      <tr><th>MÃ©thode</th><th>RÃ©sultat</th></tr>
      <tr><td>new Date().toString()</td><td id="nowString"></td></tr>
      <tr><td>new Date().toISOString()</td><td id="nowISO"></td></tr>
      <tr><td class="new">toLocalDateString(now)</td><td id="nowLocal" class="result"></td></tr>
      <tr><td class="new">toLocalTimeString(now)</td><td id="nowTimeLocal" class="result"></td></tr>
    </table>
  </div>

  <div class="box" id="isoTestBox">
    <h2>ğŸ”„ Test Date ISO (comme en base de donnÃ©es)</h2>
    <p>Date brute en BDD: <code>2025-12-06T11:00:00.000Z</code></p>
    <table>
      <tr><th>MÃ©thode</th><th>RÃ©sultat</th><th>Status</th></tr>
      <tr>
        <td class="old">âŒ ANCIEN: .split('T')[0]</td>
        <td id="isoOld"></td>
        <td id="isoOldStatus"></td>
      </tr>
      <tr>
        <td class="new">âœ… NOUVEAU: toLocalDateString()</td>
        <td id="isoNew" class="result"></td>
        <td id="isoNewStatus"></td>
      </tr>
    </table>
  </div>

  <div class="box" id="shiftTestBox">
    <h2>ğŸ” Test Comparaisons de Shifts</h2>
    <table>
      <tr><th>Shift</th><th>Date Brute</th><th>Date Locale</th><th>Est passÃ©?</th><th>A commencÃ© (09:00)?</th></tr>
      <tr id="shiftHier"></tr>
      <tr id="shiftAujourdhui"></tr>
      <tr id="shiftDemain"></tr>
    </table>
  </div>

  <div class="box" id="conclusionBox">
    <h2>ğŸ“‹ Conclusion</h2>
    <div id="conclusion"></div>
  </div>

  <script type="module">
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FONCTIONS UTILITAIRES (copie de parisTimeUtils.js)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function parseLocalDate(dateValue) {
      if (!dateValue) return null;
      if (dateValue instanceof Date) {
        return isNaN(dateValue.getTime()) ? null : dateValue;
      }
      if (typeof dateValue === 'string') {
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateValue)) {
          const [year, month, day] = dateValue.split('-').map(Number);
          return new Date(year, month - 1, day, 0, 0, 0, 0);
        }
        const dateObj = new Date(dateValue);
        if (!isNaN(dateObj.getTime())) {
          return dateObj;
        }
      }
      const parsed = new Date(dateValue);
      return isNaN(parsed.getTime()) ? null : parsed;
    }

    function toLocalDateString(dateValue) {
      const date = parseLocalDate(dateValue);
      if (!date) return null;
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function toLocalTimeString(dateValue) {
      const date = parseLocalDate(dateValue);
      if (!date) return null;
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${hours}:${minutes}`;
    }

    function createLocalDateTime(dateValue, timeString) {
      const date = parseLocalDate(dateValue);
      if (!date) return null;
      const [hours, minutes] = (timeString || '00:00').split(':').map(Number);
      return new Date(date.getFullYear(), date.getMonth(), date.getDate(), hours || 0, minutes || 0, 0, 0);
    }

    function isShiftInPast(shiftDate) {
      const date = parseLocalDate(shiftDate);
      if (!date) return false;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const shiftDay = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0, 0);
      return shiftDay < today;
    }

    function isShiftStarted(shiftDate, startTime) {
      const shiftStart = createLocalDateTime(shiftDate, startTime || '00:00');
      if (!shiftStart) return false;
      return new Date() >= shiftStart;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TESTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const now = new Date();
    
    // Mise Ã  jour heure systÃ¨me
    document.getElementById('systemTime').textContent = now.toLocaleString('fr-FR', { 
      weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', 
      hour: '2-digit', minute: '2-digit', second: '2-digit' 
    });
    
    // Test Date Actuelle
    document.getElementById('nowString').textContent = now.toString();
    document.getElementById('nowISO').textContent = now.toISOString();
    document.getElementById('nowLocal').textContent = toLocalDateString(now);
    document.getElementById('nowTimeLocal').textContent = toLocalTimeString(now);
    
    // Test Date ISO
    const dateISO = '2025-12-06T11:00:00.000Z';
    const oldMethod = dateISO.split('T')[0];
    const newMethod = toLocalDateString(dateISO);
    
    document.getElementById('isoOld').textContent = oldMethod;
    document.getElementById('isoNew').textContent = newMethod;
    
    // En France (UTC+1), 11:00 UTC = 12:00 Paris, donc c'est bien le 6 dÃ©cembre
    const expectedDate = '2025-12-06';
    document.getElementById('isoOldStatus').innerHTML = oldMethod === expectedDate ? 'âœ…' : 'âš ï¸ Peut buguer selon timezone';
    document.getElementById('isoNewStatus').innerHTML = newMethod === expectedDate ? 'âœ… Correct!' : 'âŒ Erreur';
    
    // Test Shifts
    const shifts = [
      { label: 'Hier (5 dec)', date: '2025-12-05T10:00:00.000Z' },
      { label: "Aujourd'hui (6 dec)", date: '2025-12-06T11:00:00.000Z' },
      { label: 'Demain (7 dec)', date: '2025-12-07T08:00:00.000Z' }
    ];
    
    shifts.forEach((shift, idx) => {
      const rowId = ['shiftHier', 'shiftAujourdhui', 'shiftDemain'][idx];
      const row = document.getElementById(rowId);
      const isPast = isShiftInPast(shift.date);
      const isStarted = isShiftStarted(shift.date, '09:00');
      
      row.innerHTML = `
        <td><strong>${shift.label}</strong></td>
        <td><code>${shift.date}</code></td>
        <td>${toLocalDateString(shift.date)}</td>
        <td>${isPast ? 'âœ… Oui' : 'âŒ Non'}</td>
        <td>${isStarted ? 'âœ… Oui' : 'âŒ Non'}</td>
      `;
    });
    
    // Conclusion
    const todayStr = toLocalDateString(now);
    const isCorrect = todayStr === '2025-12-06' && 
                      !isShiftInPast('2025-12-07T08:00:00.000Z') &&
                      isShiftInPast('2025-12-05T10:00:00.000Z');
    
    const conclusionBox = document.getElementById('conclusionBox');
    const conclusion = document.getElementById('conclusion');
    
    if (isCorrect) {
      conclusionBox.classList.add('success');
      conclusion.innerHTML = `
        <p style="font-size: 24px; color: #4ade80;">âœ… TOUT FONCTIONNE CORRECTEMENT !</p>
        <ul>
          <li>Date locale dÃ©tectÃ©e: <strong>${todayStr}</strong></li>
          <li>Heure locale: <strong>${toLocalTimeString(now)}</strong></li>
          <li>Le shift du 7 dÃ©cembre n'est <strong>PAS</strong> considÃ©rÃ© comme passÃ© âœ…</li>
          <li>Le shift du 5 dÃ©cembre <strong>EST</strong> considÃ©rÃ© comme passÃ© âœ…</li>
        </ul>
        <p>Les protections de remplacement devraient maintenant fonctionner correctement !</p>
      `;
    } else {
      conclusionBox.classList.add('error');
      conclusion.innerHTML = `
        <p style="font-size: 24px; color: #f87171;">âŒ PROBLÃˆME DÃ‰TECTÃ‰</p>
        <p>Date locale dÃ©tectÃ©e: ${todayStr}</p>
        <p>VÃ©rifiez la configuration timezone de votre systÃ¨me.</p>
      `;
    }
    
    // RafraÃ®chir l'heure toutes les secondes
    setInterval(() => {
      const n = new Date();
      document.getElementById('systemTime').textContent = n.toLocaleString('fr-FR', { 
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', 
        hour: '2-digit', minute: '2-digit', second: '2-digit' 
      });
      document.getElementById('nowTimeLocal').textContent = toLocalTimeString(n);
    }, 1000);
  </script>
</body>
</html>
