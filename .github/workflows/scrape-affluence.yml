name: ğŸ”´ Scrape Affluence Live (Google Maps)

on:
  schedule:
    # Toutes les 30 min pendant les heures d'ouverture (11h-23h Paris = 10h-22h UTC)
    - cron: '0,30 10-22 * * *'
  
  workflow_dispatch:  # Permet de lancer manuellement

env:
  PLACE_ID: "ChIJnYLnmZly5kcRgpLV4MN4Rus"
  GIST_ID: "d58c52b36d59dc78de0af9286881cdec"

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: ğŸ“¦ Install Dependencies
        run: npm install puppeteer puppeteer-extra puppeteer-extra-plugin-stealth
      
      - name: ğŸ”´ Scrape Google Maps Affluence
        id: scrape
        run: |
          node << 'SCRIPT'
          const puppeteer = require('puppeteer-extra');
          const StealthPlugin = require('puppeteer-extra-plugin-stealth');
          const https = require('https');
          const fs = require('fs');
          
          puppeteer.use(StealthPlugin());
          
          const PLACE_ID = process.env.PLACE_ID;
          const GIST_ID = process.env.GIST_ID;
          const GITHUB_TOKEN = process.env.GIST_TOKEN;
          
          // Mapping texte franÃ§ais -> score (utilise regex pour eviter problemes apostrophes)
          function textToScore(text) {
            if (!text) return null;
            const t = text.toLowerCase();
            
            // Textes "live" comparatifs - regex avec [''] pour matcher les 2 types d apostrophes
            if (/moins fr.quent. que d.habitude/i.test(t)) return 35;
            if (/plus fr.quent. que d.habitude/i.test(t)) return 75;
            if (/aussi fr.quent. que d.habitude/i.test(t)) return 50;
            
            // Textes absolus
            if (/pas trop fr.quent/i.test(t) || /tr.s peu fr.quent/i.test(t)) return 15;
            if (/peu fr.quent/i.test(t) && !/assez/i.test(t)) return 25;
            if (/assez peu fr.quent/i.test(t)) return 30;
            if (/assez fr.quent/i.test(t) && !/peu/i.test(t)) return 60;
            if (/tr.s fr.quent/i.test(t)) return 90;
            if (/fr.quent/i.test(t)) return 50;
            
            return null;
          }
          
          async function scrapeGoogleMaps() {
            console.log('ğŸ”´ DÃ©marrage scraping Google Maps...');
            
            const browser = await puppeteer.launch({
              headless: 'new',
              args: [
                '--no-sandbox',
                '--disable-setuid-sandbox',
                '--disable-dev-shm-usage',
                '--disable-gpu',
                '--single-process',
                '--disable-blink-features=AutomationControlled'
              ]
            });
            
            try {
              const page = await browser.newPage();
              
              // User agent rÃ©aliste
              await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36');
              await page.setExtraHTTPHeaders({ 
                'Accept-Language': 'fr-FR,fr;q=0.9,en;q=0.8',
                'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8'
              });
              
              // Viewport desktop
              await page.setViewport({ width: 1366, height: 768 });
              
              // URL Google Maps directe avec Place ID
              const url = `https://www.google.com/maps/place/?q=place_id:${PLACE_ID}&hl=fr`;
              console.log('ğŸ”´ Navigation vers:', url);
              
              await page.goto(url, {
                waitUntil: 'networkidle2',
                timeout: 30000
              });
              
              // Attendre un peu que la page charge
              await new Promise(r => setTimeout(r, 3000 + Math.random() * 2000));
              
              // Accepter les cookies si prÃ©sent
              try {
                const acceptButton = await page.$('button[aria-label*="Accepter"]');
                if (acceptButton) {
                  await acceptButton.click();
                  await new Promise(r => setTimeout(r, 1000));
                }
              } catch (e) {}
              
              // Screenshot pour debug
              await page.screenshot({ path: 'google-maps-screenshot.png', fullPage: false });
              console.log('ğŸ“¸ Screenshot sauvegardÃ©');
              
              // Chercher les donnÃ©es d'affluence
              const result = await page.evaluate(() => {
                const bodyText = document.body?.innerText || '';
                
                // VÃ©rifier si on est sur la bonne page (pas un CAPTCHA)
                const isCaptcha = bodyText.includes('unusual traffic') || 
                                  bodyText.includes('trafic exceptionnel') ||
                                  bodyText.includes('pas un robot');
                
                if (isCaptcha) {
                  return { error: 'CAPTCHA', debug: bodyText.substring(0, 500) };
                }
                
                // Patterns pour l'affluence live
                const livePatterns = [
                  /moins frÃ©quentÃ© que d['']habitude/i,
                  /plus frÃ©quentÃ© que d['']habitude/i,
                  /aussi frÃ©quentÃ© que d['']habitude/i,
                  /trÃ¨s peu frÃ©quentÃ©/i,
                  /peu frÃ©quentÃ©/i,
                  /assez frÃ©quentÃ©/i,
                  /trÃ¨s frÃ©quentÃ©/i,
                  /pas trop frÃ©quentÃ©/i
                ];
                
                for (const pattern of livePatterns) {
                  const match = bodyText.match(pattern);
                  if (match) {
                    return { 
                      liveText: match[0], 
                      found: true,
                      debug: bodyText.substring(0, 300)
                    };
                  }
                }
                
                // Chercher le pourcentage directement (ex: "75% d'affluence")
                const percentMatch = bodyText.match(/(\d{1,3})\s*%.*(?:affluence|frÃ©quent)/i);
                if (percentMatch) {
                  return {
                    liveText: `${percentMatch[1]}% d'affluence`,
                    score: parseInt(percentMatch[1]),
                    found: true
                  };
                }
                
                return { 
                  liveText: null, 
                  found: false, 
                  debug: bodyText.substring(0, 500) 
                };
              });
              
              await browser.close();
              return result;
              
            } catch (err) {
              await browser.close();
              throw err;
            }
          }
          
          async function updateGist(data) {
            const content = JSON.stringify(data, null, 2);
            
            // Sauvegarder localement aussi
            fs.writeFileSync('affluence-live.json', content);
            console.log('ğŸ’¾ Fichier local sauvegardÃ©');
            
            return new Promise((resolve, reject) => {
              const req = https.request({
                hostname: 'api.github.com',
                path: '/gists/' + GIST_ID,
                method: 'PATCH',
                headers: {
                  'Authorization': 'token ' + GITHUB_TOKEN,
                  'User-Agent': 'GitHub-Actions-Scraper',
                  'Content-Type': 'application/json',
                }
              }, res => {
                let body = '';
                res.on('data', chunk => body += chunk);
                res.on('end', () => {
                  if (res.statusCode === 200) {
                    console.log('âœ… Gist mis Ã  jour avec succÃ¨s !');
                    resolve();
                  } else {
                    console.error('âŒ Erreur Gist:', res.statusCode, body);
                    reject(new Error('Gist update failed: ' + res.statusCode));
                  }
                });
              });
              
              req.on('error', reject);
              req.write(JSON.stringify({
                files: {
                  'affluence-live.json': { content }
                }
              }));
              req.end();
            });
          }
          
          // Main
          (async () => {
            try {
              const result = await scrapeGoogleMaps();
              console.log('ğŸ“Š RÃ©sultat:', JSON.stringify(result, null, 2));
              
              if (result.error === 'CAPTCHA') {
                console.log('âš ï¸ CAPTCHA dÃ©tectÃ© - Pas de mise Ã  jour');
                console.log('Debug:', result.debug);
                process.exit(0); // Exit propre, ne pas faire Ã©chouer le workflow
              }
              
              if (result.found && result.liveText) {
                const score = result.score || textToScore(result.liveText);
                
                const data = {
                  score,
                  liveText: result.liveText,
                  isLive: true,
                  scrapedAt: new Date().toISOString(),
                  source: 'google-maps-live'
                };
                
                console.log('ğŸ“ DonnÃ©es Ã  sauvegarder:', data);
                await updateGist(data);
                console.log('ğŸ‰ SuccÃ¨s !');
              } else {
                console.log('âš ï¸ Pas de donnÃ©es live trouvÃ©es');
                if (result.debug) {
                  console.log('Debug (extrait):', result.debug.substring(0, 300));
                }
              }
              
              process.exit(0);
            } catch (err) {
              console.error('âŒ Erreur:', err.message);
              process.exit(1);
            }
          })();
          SCRIPT
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: ${{ secrets.GIST_ID }}
          PLACE_ID: ${{ env.PLACE_ID }}
      
      - name: ğŸ“Š Upload debug artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: scrape-debug-${{ github.run_id }}
          path: |
            google-maps-screenshot.png
            affluence-live.json
          retention-days: 3
