name: ðŸ”´ Scrape Affluence Live (Google Maps)

on:
  schedule:
    # Toutes les 30 min pendant les heures d'ouverture (11h-23h Paris = 10h-22h UTC)
    - cron: '0,30 10-22 * * *'
  
  workflow_dispatch:  # Permet de lancer manuellement

env:
  PLACE_ID: "ChIJnYLnmZly5kcRgpLV4MN4Rus"
  GIST_ID: "d58c52b36d59dc78de0af9286881cdec"

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Dependencies
        run: npm install puppeteer puppeteer-extra puppeteer-extra-plugin-stealth
      
      - name: Scrape Google Maps Affluence
        id: scrape
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
        run: |
          node << 'SCRIPT'
          const puppeteer = require('puppeteer-extra');
          const StealthPlugin = require('puppeteer-extra-plugin-stealth');
          const https = require('https');
          const fs = require('fs');
          
          puppeteer.use(StealthPlugin());
          
          const PLACE_ID = process.env.PLACE_ID;
          const GIST_ID = process.env.GIST_ID;
          const GITHUB_TOKEN = process.env.GIST_TOKEN;
          const wait = ms => new Promise(r => setTimeout(r, ms));
          
          // Mapping texte -> score
          function textToScore(text) {
            if (!text) return null;
            const t = text.toLowerCase();
            if (/moins fr.quent/i.test(t)) return 30;
            if (/plus fr.quent/i.test(t)) return 75;
            if (/aussi fr.quent/i.test(t)) return 50;
            if (/pas trop fr.quent/i.test(t) || /tr.s peu fr.quent/i.test(t)) return 15;
            if (/peu fr.quent/i.test(t) && !/assez/i.test(t)) return 25;
            if (/assez peu fr.quent/i.test(t)) return 30;
            if (/assez fr.quent/i.test(t) && !/peu/i.test(t)) return 60;
            if (/tr.s fr.quent/i.test(t)) return 90;
            if (/fr.quent/i.test(t)) return 50;
            return null;
          }
          
          async function scrapeGoogleMaps() {
            console.log('Demarrage scraping Google Maps...');
            
            const browser = await puppeteer.launch({
              headless: 'new',
              args: [
                '--no-sandbox',
                '--disable-setuid-sandbox',
                '--disable-dev-shm-usage',
                '--disable-gpu',
                '--single-process',
                '--disable-blink-features=AutomationControlled'
              ]
            });
            
            try {
              const page = await browser.newPage();
              await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36');
              await page.setViewport({ width: 1366, height: 800 });
              
              const url = 'https://www.google.com/maps/place/?q=place_id:' + PLACE_ID + '&hl=fr';
              console.log('Navigation:', url);
              
              await page.goto(url, { waitUntil: 'networkidle2', timeout: 30000 });
              await wait(3000);
              
              // Accepter cookies
              console.log('Gestion cookies...');
              try {
                await page.evaluate(() => {
                  const buttons = Array.from(document.querySelectorAll('button'));
                  const acceptBtn = buttons.find(b => 
                    b.textContent.includes('Tout accepter') || 
                    b.textContent.includes('Accept all')
                  );
                  if (acceptBtn) acceptBtn.click();
                });
                await wait(2000);
              } catch (e) {}
              
              // Clic sur A propos
              console.log('Clic sur A propos...');
              try {
                await page.evaluate(() => {
                  const buttons = Array.from(document.querySelectorAll('button'));
                  const aboutBtn = buttons.find(b => b.textContent.includes('propos'));
                  if (aboutBtn) aboutBtn.click();
                });
                await wait(2000);
              } catch (e) {}
              
              // Scroll pour charger les donnees
              console.log('Scroll...');
              for (let i = 0; i < 5; i++) {
                await page.evaluate(() => {
                  document.querySelectorAll('div').forEach(div => {
                    if (div.scrollHeight > div.clientHeight + 100 && div.clientHeight > 200) {
                      div.scrollBy(0, 400);
                    }
                  });
                });
                await wait(1000);
              }
              
              // Screenshot debug
              await page.screenshot({ path: 'google-maps-screenshot.png', fullPage: false });
              console.log('Screenshot sauvegarde');
              
              // Extraire les donnees
              const result = await page.evaluate(() => {
                const bodyText = document.body.innerText;
                
                // Patterns affluence live
                const livePatterns = [
                  /moins fr.quent. que d.habitude/i,
                  /plus fr.quent. que d.habitude/i,
                  /aussi fr.quent. que d.habitude/i,
                  /tr.s peu fr.quent/i,
                  /peu fr.quent/i,
                  /assez fr.quent/i,
                  /tr.s fr.quent/i,
                  /pas trop fr.quent/i
                ];
                
                let liveText = null;
                for (const p of livePatterns) {
                  const m = bodyText.match(p);
                  if (m) { liveText = m[0]; break; }
                }
                
                // Chercher aria-labels avec affluence actuelle
                let currentPercent = null;
                let typicalPercent = null;
                document.querySelectorAll('[aria-label]').forEach(el => {
                  const label = el.getAttribute('aria-label');
                  // Format: "Taux de frequentation actuel de X % (Y % en general)."
                  const match = label.match(/actuel de (\d+)\s*%.*?(\d+)\s*%/i);
                  if (match) {
                    currentPercent = parseInt(match[1]);
                    typicalPercent = parseInt(match[2]);
                  }
                });
                
                return { liveText, currentPercent, typicalPercent };
              });
              
              await browser.close();
              return result;
              
            } catch (err) {
              await browser.close();
              throw err;
            }
          }
          
          async function updateGist(data) {
            const content = JSON.stringify(data, null, 2);
            fs.writeFileSync('affluence-live.json', content);
            console.log('Fichier local sauvegarde');
            
            return new Promise((resolve, reject) => {
              const req = https.request({
                hostname: 'api.github.com',
                path: '/gists/' + GIST_ID,
                method: 'PATCH',
                headers: {
                  'Authorization': 'token ' + GITHUB_TOKEN,
                  'User-Agent': 'GitHub-Actions-Scraper',
                  'Content-Type': 'application/json',
                }
              }, res => {
                let body = '';
                res.on('data', chunk => body += chunk);
                res.on('end', () => {
                  if (res.statusCode >= 200 && res.statusCode < 300) {
                    console.log('Gist mis a jour avec succes!');
                    resolve(body);
                  } else {
                    console.error('Erreur Gist:', res.statusCode, body);
                    reject(new Error('Gist update failed: ' + res.statusCode));
                  }
                });
              });
              
              req.on('error', reject);
              req.write(JSON.stringify({
                files: { 'affluence-live.json': { content } }
              }));
              req.end();
            });
          }
          
          async function main() {
            try {
              const result = await scrapeGoogleMaps();
              console.log('Resultat scraping:', result);
              
              // Calculer le score
              let score = 50; // defaut
              let isLive = false;
              let source = 'estimated';
              
              if (result.currentPercent !== null) {
                score = result.currentPercent;
                isLive = true;
                source = 'google-maps-current';
                console.log('Score live (current):', score);
              } else if (result.liveText) {
                score = textToScore(result.liveText) || 50;
                isLive = true;
                source = 'google-maps-text';
                console.log('Score live (text):', score, 'from:', result.liveText);
              }
              
              const data = {
                score,
                liveText: result.liveText,
                currentPercent: result.currentPercent,
                typicalPercent: result.typicalPercent,
                isLive,
                source,
                timestamp: new Date().toISOString(),
                placeId: PLACE_ID
              };
              
              await updateGist(data);
              console.log('Termine avec succes!');
              
            } catch (err) {
              console.error('Erreur:', err.message);
              
              // Fallback: mettre a jour avec estimation
              const now = new Date();
              const hour = now.getHours();
              let score = 50;
              if (hour >= 12 && hour <= 14) score = 70;
              if (hour >= 19 && hour <= 21) score = 80;
              if (hour < 11 || hour > 23) score = 10;
              
              const data = {
                score,
                isLive: false,
                source: 'estimated-fallback',
                error: err.message,
                timestamp: new Date().toISOString()
              };
              
              await updateGist(data);
              process.exit(1);
            }
          }
          
          main();
          SCRIPT
      
      - name: Upload Screenshot
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: google-maps-screenshot
          path: google-maps-screenshot.png
          retention-days: 1
