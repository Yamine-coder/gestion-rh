name: ï¿½ Scrape Affluence Live (Puppeteer)

on:
  schedule:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SCRAPING GRATUIT avec Puppeteer - toutes les 30 min heures ouverture
    # GitHub Actions = 2000 min/mois gratuit = ~60 runs/jour possible
    # On fait 26 runs/jour (11h-23h = 13h Ã— 2/heure)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - cron: '0,30 10-22 * * *'  # Toutes les 30 min de 11h Ã  23h Paris (10-22 UTC)
  
  workflow_dispatch:  # Permet de lancer manuellement

env:
  RESTAURANT_NAME: "Chez Antoine Vincennes"
  PLACE_ID: "ChIJnYLnmZly5kcRgpLV4MN4Rus"
  GIST_ID: "d58c52b36d59dc78de0af9286881cdec"

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: ğŸ“¦ Install Puppeteer
        run: npm install puppeteer puppeteer-extra puppeteer-extra-plugin-stealth
      
      - name: ğŸ”´ Scrape Google Affluence (Puppeteer)
        id: scrape
        run: |
          node << 'SCRIPT'
          const puppeteer = require('puppeteer-extra');
          const StealthPlugin = require('puppeteer-extra-plugin-stealth');
          const https = require('https');
          const fs = require('fs');
          
          puppeteer.use(StealthPlugin());
          
          const GIST_ID = process.env.GIST_ID;
          const GITHUB_TOKEN = process.env.GIST_TOKEN;
          
          // Mapping texte -> score
          function textToScore(text) {
            const t = text.toLowerCase();
            if (t.includes('trÃ¨s peu') || t.includes('pas trop')) return 15;
            if (t.includes('moins frÃ©quentÃ©')) return 30;
            if (t.includes('peu frÃ©quentÃ©')) return 25;
            if (t.includes('aussi frÃ©quentÃ©')) return 50;
            if (t.includes('assez frÃ©quentÃ©')) return 60;
            if (t.includes('plus frÃ©quentÃ©')) return 75;
            if (t.includes('trÃ¨s frÃ©quentÃ©')) return 85;
            if (t.includes('frÃ©quentÃ©')) return 50;
            return null;
          }
          
          async function scrapeAffluence() {
            console.log('ğŸ”´ DÃ©marrage scraping Puppeteer...');
            
            const browser = await puppeteer.launch({
              headless: 'new',
              args: [
                '--no-sandbox',
                '--disable-setuid-sandbox',
                '--disable-dev-shm-usage',
                '--disable-gpu',
                '--single-process'
              ]
            });
            
            try {
              const page = await browser.newPage();
              await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36');
              await page.setExtraHTTPHeaders({ 'Accept-Language': 'fr-FR,fr;q=0.9' });
              
              console.log('ğŸ”´ Navigation vers Google...');
              await page.goto('https://www.google.fr/search?q=Chez+Antoine+Vincennes+restaurant&hl=fr&gl=fr', {
                waitUntil: 'networkidle2',
                timeout: 30000
              });
              
              await new Promise(r => setTimeout(r, 3000));
              
              // Screenshot pour debug
              await page.screenshot({ path: 'google-screenshot.png', fullPage: true });
              console.log('ğŸ“¸ Screenshot sauvegardÃ©');
              
              const result = await page.evaluate(() => {
                const text = document.body?.innerText || '';
                const patterns = [
                  /Moins\s+frÃ©quentÃ©\s+que\s+d'habitude/i,
                  /Plus\s+frÃ©quentÃ©\s+que\s+d'habitude/i,
                  /Aussi\s+frÃ©quentÃ©\s+que\s+d'habitude/i,
                  /Pas\s+trop\s+frÃ©quentÃ©/i,
                  /GÃ©nÃ©ralement\s+(trÃ¨s\s+)?peu\s+frÃ©quentÃ©/i,
                  /GÃ©nÃ©ralement\s+(trÃ¨s\s+)?frÃ©quentÃ©/i,
                  /assez\s+frÃ©quentÃ©/i,
                ];
                
                for (const p of patterns) {
                  const match = text.match(p);
                  if (match) return { liveText: match[0], found: true };
                }
                return { liveText: null, found: false, debug: text.substring(0, 500) };
              });
              
              await browser.close();
              return result;
              
            } catch (err) {
              await browser.close();
              throw err;
            }
          }
          
          async function updateGist(data) {
            const content = JSON.stringify(data, null, 2);
            
            // Sauvegarder localement aussi
            fs.writeFileSync('affluence-live.json', content);
            
            return new Promise((resolve, reject) => {
              const req = https.request({
                hostname: 'api.github.com',
                path: '/gists/' + GIST_ID,
                method: 'PATCH',
                headers: {
                  'Authorization': 'token ' + GITHUB_TOKEN,
                  'User-Agent': 'GitHub-Actions-Scraper',
                  'Content-Type': 'application/json',
                }
              }, res => {
                let body = '';
                res.on('data', chunk => body += chunk);
                res.on('end', () => {
                  if (res.statusCode === 200) {
                    console.log('âœ… Gist mis Ã  jour !');
                    resolve();
                  } else {
                    console.error('âŒ Gist error:', res.statusCode, body);
                    reject(new Error('Gist update failed: ' + res.statusCode));
                  }
                });
              });
              
              req.on('error', reject);
              req.write(JSON.stringify({
                files: {
                  'affluence-live.json': { content }
                }
              }));
              req.end();
            });
          }
          
          (async () => {
            try {
              const result = await scrapeAffluence();
              console.log('ğŸ“Š RÃ©sultat scraping:', JSON.stringify(result, null, 2));
              
              if (result.found && result.liveText) {
                const score = textToScore(result.liveText);
                const data = {
                  score,
                  liveText: result.liveText,
                  isLive: true,
                  scrapedAt: new Date().toISOString(),
                  source: 'github-actions-puppeteer'
                };
                
                console.log('ğŸ“ DonnÃ©es:', data);
                await updateGist(data);
                console.log('ğŸ‰ SuccÃ¨s !');
              } else {
                console.log('âš ï¸ Pas de donnÃ©es live trouvÃ©es');
                console.log('Debug:', result.debug);
              }
              
              process.exit(0);
            } catch (err) {
              console.error('âŒ Erreur:', err.message);
              process.exit(1);
            }
          })();
          SCRIPT
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: ${{ env.GIST_ID }}
      
      - name: ğŸ“Š Upload debug artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: scrape-debug-${{ github.run_id }}
          path: |
            google-screenshot.png
            affluence-live.json
          retention-days: 3
