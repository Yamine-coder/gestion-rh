/**
 * Script de test pour vÃ©rifier l'affichage des retards en live
 * Ce script crÃ©e un shift et des pointages avec retards pour tester
 */

const axios = require('axios');

const API_URL = 'http://localhost:5000';
const TEST_EMPLOYE_ID = 56; // LÃ©a Garcia
const TEST_DATE = '2025-11-29';

// Token d'authentification (vous devez Ãªtre connectÃ© en tant qu'admin)
// Pour obtenir un token: connectez-vous via l'interface et rÃ©cupÃ©rez-le depuis localStorage
const AUTH_TOKEN = process.env.AUTH_TOKEN || '';

async function testRetards() {
  console.log('ğŸ§ª TEST DES RETARDS - VÃ‰RIFICATION LIVE\n');
  console.log('=' .repeat(60));

  try {
    // 1. CrÃ©er un shift prÃ©vu
    console.log('\nğŸ“‹ Ã‰tape 1: CrÃ©ation d\'un shift prÃ©vu');
    console.log(`   EmployÃ©: ${TEST_EMPLOYE_ID}, Date: ${TEST_DATE}`);
    console.log(`   Horaire prÃ©vu: 09:00 - 17:00`);
    
    const shiftData = {
      employeId: TEST_EMPLOYE_ID,
      date: TEST_DATE,
      type: 'prÃ©sence',
      segments: [
        {
          start: '09:00',
          end: '17:00',
          commentaire: 'Test retard'
        }
      ]
    };

    // 2. CrÃ©er des pointages avec diffÃ©rents types de retards
    console.log('\nâ° Ã‰tape 2: CrÃ©ation de pointages avec retards');
    
    // RETARD MODÃ‰RÃ‰: 9:12 (12 min de retard, entre 5 et 20 min)
    console.log('\n   A) RETARD MODÃ‰RÃ‰: ArrivÃ©e Ã  09:12 (12 min de retard)');
    const pointageRetardModere = {
      userId: TEST_EMPLOYE_ID,
      type: 'arrivee',
      horodatage: new Date(`${TEST_DATE}T09:12:00+01:00`).toISOString()
    };
    
    // DÃ©part normal
    const pointageDepart = {
      userId: TEST_EMPLOYE_ID,
      type: 'depart',
      horodatage: new Date(`${TEST_DATE}T17:00:00+01:00`).toISOString()
    };

    // 3. Appeler l'API de comparaison
    console.log('\nğŸ” Ã‰tape 3: Appel de l\'API de comparaison');
    console.log(`   GET /api/comparison/planning-vs-realite?employeId=${TEST_EMPLOYE_ID}&date=${TEST_DATE}`);
    
    const headers = AUTH_TOKEN ? { Authorization: `Bearer ${AUTH_TOKEN}` } : {};
    
    const response = await axios.get(`${API_URL}/api/comparison/planning-vs-realite`, {
      params: {
        employeId: TEST_EMPLOYE_ID,
        date: TEST_DATE
      },
      headers
    });

    // 4. Analyser les rÃ©sultats
    console.log('\nğŸ“Š Ã‰tape 4: Analyse des rÃ©sultats\n');
    console.log('=' .repeat(60));
    
    if (response.data.success && response.data.comparaisons.length > 0) {
      const comparaison = response.data.comparaisons[0];
      
      console.log(`\nâœ… Comparaison trouvÃ©e pour le ${comparaison.date}`);
      console.log(`   - Nombre d'Ã©carts: ${comparaison.ecarts.length}`);
      
      if (comparaison.ecarts.length > 0) {
        console.log('\nğŸ“‹ DÃ‰TAIL DES Ã‰CARTS:\n');
        
        comparaison.ecarts.forEach((ecart, idx) => {
          console.log(`   ${idx + 1}. ${ecart.type.toUpperCase()}`);
          console.log(`      â”œâ”€ GravitÃ©: ${ecart.gravite}`);
          console.log(`      â”œâ”€ DurÃ©e: ${ecart.dureeMinutes || 0} minutes`);
          console.log(`      â”œâ”€ Description: ${ecart.description}`);
          
          if (ecart.type.includes('retard')) {
            console.log(`      â””â”€ âš ï¸ RETARD DÃ‰TECTÃ‰! âš ï¸`);
          }
          console.log('');
        });
        
        // VÃ©rifications spÃ©cifiques
        const retards = comparaison.ecarts.filter(e => e.type.includes('retard'));
        
        console.log('\n' + '='.repeat(60));
        console.log('ğŸ¯ RÃ‰SULTAT DU TEST:\n');
        
        if (retards.length > 0) {
          console.log(`âœ… SUCCÃˆS: ${retards.length} retard(s) dÃ©tectÃ©(s)`);
          retards.forEach(r => {
            console.log(`   - Type: ${r.type}`);
            console.log(`   - DurÃ©e: ${r.dureeMinutes} minutes`);
            console.log(`   - GravitÃ©: ${r.gravite}`);
          });
          
          console.log('\nğŸ“± VÃ‰RIFICATION FRONTEND:');
          console.log('   1. Activez le mode comparaison dans l\'interface');
          console.log('   2. Cherchez l\'employÃ© ID ' + TEST_EMPLOYE_ID + ' le ' + TEST_DATE);
          console.log('   3. Vous devriez voir un badge avec:');
          console.log('      - IcÃ´ne: ğŸŸ¡ (retard modÃ©rÃ©) ou ğŸ”´ (retard critique)');
          console.log('      - Label: "Retard modÃ©rÃ©" ou "Retard critique"');
          console.log('      - DurÃ©e en minutes');
          
        } else {
          console.log('âŒ Ã‰CHEC: Aucun retard dÃ©tectÃ©');
          console.log('   Les Ã©carts dÃ©tectÃ©s sont:');
          comparaison.ecarts.forEach(e => console.log(`   - ${e.type}`));
        }
        
      } else {
        console.log('âš ï¸ Aucun Ã©cart dÃ©tectÃ©');
      }
      
    } else {
      console.log('âŒ Aucune comparaison trouvÃ©e');
    }
    
    console.log('\n' + '='.repeat(60));
    console.log('\nğŸ’¡ CONSEILS DE DÃ‰BOGAGE:');
    console.log('   1. VÃ©rifiez les logs du serveur pour voir:');
    console.log('      - "ğŸŸ¡ RETARD MODÃ‰RÃ‰ DÃ‰TECTÃ‰"');
    console.log('      - "ğŸ”´ RETARD CRITIQUE DÃ‰TECTÃ‰"');
    console.log('      - "ğŸ“¤ Ã‰CART ARRIVÃ‰E AJOUTÃ‰"');
    console.log('');
    console.log('   2. VÃ©rifiez la console du navigateur pour voir:');
    console.log('      - "ğŸ” getEcartsForEmployeeDate appelÃ©"');
    console.log('      - "âœ… Config trouvÃ©e pour type"');
    console.log('      - "ğŸ¯ CellDrop - RETARDS DANS LA CELLULE"');
    console.log('');
    console.log('   3. Ouvrez les DevTools du navigateur (F12)');
    console.log('   4. Allez dans l\'onglet Console');
    console.log('   5. Activez le mode comparaison dans l\'interface');
    console.log('');
    
  } catch (error) {
    console.error('\nâŒ ERREUR:', error.message);
    if (error.response) {
      console.error('   Statut:', error.response.status);
      console.error('   DÃ©tails:', error.response.data);
    }
  }
  
  console.log('\nğŸ Test terminÃ©\n');
}

// ExÃ©cuter le test
testRetards();
